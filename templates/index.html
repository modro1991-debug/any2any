<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Any2Any — Free Online File Converter</title>
<style>
  :root{ --bg:#0b1020;--panel:#0f1630;--card:#121a3a;--muted:#9ab0d6;--line:#1f2a4a;--cta:#2a66ff;--ok:#1f8a4d;--err:#a23a3a; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e7ecf5;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  .wrap{max-width:960px;margin:auto;padding:24px} .hero{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:28px}
  h1{margin:0 0 6px 0;font-size:28px} .muted{color:var(--muted);font-size:14px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr;margin-top:18px} @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}

  .drop{position:relative;border:2px dashed var(--line);background:var(--card);border-radius:16px;padding:22px;display:flex;align-items:center;justify-content:center;min-height:180px;text-align:center;transition:.2s}
  .drop.drag{border-color:var(--cta);box-shadow:0 0 0 3px rgba(42,102,255,.25) inset}
  #file{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  .cta{display:inline-flex;align-items:center;gap:8px;background:var(--cta);border:none;padding:10px 14px;border-radius:12px;color:white;font-weight:600;cursor:pointer}
  .filemeta{margin-top:10px;font-size:14px;color:var(--muted)}
  label[for="file"]{display:inline-block}

  .section-title{margin:0 0 8px 0;font-size:14px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);background:#0b1020;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
  .chip.active,.chip:hover{border-color:var(--cta);box-shadow:0 0 0 2px rgba(42,102,255,.25)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  select,button{background:#0b1020;color:#e7ecf5;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  button.convert{background:var(--cta);border:none;font-weight:600} button.convert[disabled]{opacity:.6;cursor:not-allowed}

  .progress{height:8px;background:#1a2448;border-radius:6px;overflow:hidden;margin-top:12px;position:relative}
  .bar{height:8px;background:var(--cta);width:0%}
  .bar.indeterminate{position:absolute;left:0;top:0;width:100%;height:8px;background:linear-gradient(90deg, rgba(42,102,255,0) 0%, rgba(42,102,255,.6) 50%, rgba(42,102,255,0) 100%);background-size:200% 100%;animation:slide 1.2s linear infinite}
  @keyframes slide{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .statusline{margin-top:6px;font-size:13px;color:#9ab0d6}
  .result{margin-top:12px;font-size:14px} .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0b1020}
  .pill.ok{background:#0f2f1a;border-color:#1d623a} .pill.err{background:#2f1010;border-color:#6a2a2a} a.link{color:#7fb2ff;text-decoration:none}

  .cookie-banner{position:fixed;left:12px;right:12px;bottom:12px;z-index:50;background:#121a3a;border:1px solid #1f2a4a;color:#e7ecf5;border-radius:14px;padding:12px 14px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .cookie-banner.show{display:flex;align-items:center;gap:12px;flex-wrap:wrap} .cookie-banner p{margin:0;font-size:14px;color:#9ab0d6}
  .cookie-actions{margin-left:auto;display:flex;gap:8px} .cookie-btn{border:1px solid #1f2a4a;background:#0b1020;color:#e7ecf5;padding:8px 12px;border-radius:10px;cursor:pointer}
  .cookie-btn.primary{background:#2a66ff;border:none;font-weight:600}
  .toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:#9ab0d6;margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Any2Any File Converter</h1>
      <div class="muted">Fast, private, and free. Files are processed temporarily and auto-deleted. We don’t store your files.</div>

      <div class="grid">
        <!-- Left -->
        <div class="panel">
          <div id="drop" class="drop" tabindex="0">
            <div>
              <div style="font-weight:600;margin-bottom:6px;">Drag & drop a file</div>
              <div class="muted">or</div><br/>
              <input id="file" type="file" />
              <label for="file">
                <button id="browseBtn" class="cta" type="button" aria-controls="file">Choose file</button>
              </label>
              <div id="filemeta" class="filemeta" aria-live="polite"></div>
            </div>
          </div>

          <div class="progress"><div id="bar" class="bar"></div><div id="barInd" class="bar" style="display:none"></div></div>
          <div id="status" class="statusline"></div>
          <div id="result" class="result"></div>
        </div>

        <!-- Right -->
        <div class="panel">
          <div class="section-title">Target format</div>
          <div id="chips" class="chips"></div>
          <div class="row" style="margin-top:8px">
            <select id="targetSelect" aria-label="All formats"></select>
            <button id="convertBtn" class="convert" type="button" disabled>Convert</button>
          </div>
          <label class="toggle">
            <input id="localToggle" type="checkbox"/>
            Process in my browser (beta) — images & PDF→images
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Cookie banner -->
  <div id="cookieBanner" class="cookie-banner" role="dialog" aria-live="polite" aria-label="Cookie consent">
    <p>We use a small cookie to remember your choice. No tracking, no ads.</p>
    <div class="cookie-actions">
      <button id="cookieAccept" class="cookie-btn primary">Accept</button>
      <button id="cookieDecline" class="cookie-btn">Decline</button>
    </div>
  </div>

  <!-- libs for local conversion -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
  (function(){
    const $ = (q)=>document.querySelector(q);
    const fileInput=$("#file"), browseBtn=$("#browseBtn");
    const chipsWrap=$("#chips"), targetSelect=$("#targetSelect"), convertBtn=$("#convertBtn");
    const filemeta=$("#filemeta"), drop=$("#drop");
    const bar=$("#bar"), barInd=$("#barInd"), statusLine=$("#status"), resultBox=$("#result"), localToggle=$("#localToggle");

    const IMAGE_IN=["jpg","jpeg","png","webp","gif","tiff","bmp","ico","pdf"];
    const AV_IN   =["mp3","wav","aac","flac","ogg","mp4","mkv","mov","webm"];
    const DOC_IN  =["pdf","doc","docx","ppt","pptx","xls","xlsx","odt","odp","ods","rtf","txt"];
    const DATA_IN =["csv","xlsx","txt","vcf","srt","vtt","json","yaml","yml"];
    const IMAGE_OUT=IMAGE_IN, AV_OUT=AV_IN, DOC_OUT=["pdf","docx","pptx","xlsx","odt","odp","ods"];
    const DATA_OUT=["phonecsv","csv","vcf","srt","vtt","csv_from_json","json_from_csv","json_from_yaml","yaml_from_json"];

    const PDFJS = window['pdfjsLib'];
    PDFJS.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.js";

    function extOf(n){const m=/\.[^.]+$/.exec(n||"");return m?m[0].slice(1).toLowerCase():"";}
    function humanSize(n){if(!n&&n!==0)return"";const u=["B","KB","MB","GB"];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return`${n.toFixed(n<10&&i?1:0)} ${u[i]}`;}
    function guessCategory(ext){ if(ext==="pdf") return "doc"; if(IMAGE_IN.includes(ext)) return "image"; if(AV_IN.includes(ext)) return ["mp4","mkv","mov","webm"].includes(ext)?"video":"audio"; if(DOC_IN.includes(ext)) return "doc"; if(DATA_IN.includes(ext)) return "data"; return "doc"; }

    function suggestedTargets(ext, cat){
      if(ext==="pdf") return ["jpg","png","webp","docx"];
      if(cat==="image")  return ["jpg","png","webp","pdf"].filter(x=>x!==ext);
      if(cat==="video")  return ["mp4","webm","mp3"];
      if(cat==="audio")  return ["mp3","wav","aac","flac"].filter(x=>x!==ext);
      if(cat==="doc")    return ["pdf","docx","pptx","xlsx","odt","odp","ods"].filter(x=>x!==ext);
      if(cat==="data")   return ["phonecsv","csv","vcf","vtt","srt","csv_from_json","json_from_csv"];
      return [];
    }
    function allTargetsFor(ext, cat){
      if(ext==="pdf"){ const imgs=IMAGE_OUT.filter(x=>x!=="pdf"); return [...new Set([...imgs,"docx"])]; }
      if(cat==="image") return IMAGE_OUT.filter(x=>x!==ext);
      if(cat==="video"||cat==="audio") return AV_OUT.filter(x=>x!==ext);
      if(cat==="data") return DATA_OUT;
      return DOC_OUT.filter(x=>x!==ext);
    }

    function enableConvertIfReady(){
      const hasFile = !!fileInput.files?.length;
      const hasTarget = !!targetSelect.value;
      convertBtn.disabled = !(hasFile && hasTarget);
    }

    function setSuggestions(ext, cat){
      chipsWrap.innerHTML="";
      const opts = allTargetsFor(ext, cat);
      targetSelect.innerHTML = opts.map(o=>`<option value="${o}">${o.toUpperCase()}</option>`).join("");

      // if there are no options, keep disabled
      if(!opts.length){ enableConvertIfReady(); return; }

      const top = suggestedTargets(ext, cat).filter(x=>opts.includes(x));
      top.forEach(fmt=>{
        const chip=document.createElement("button");
        chip.type="button"; chip.className="chip"; chip.textContent=fmt.toUpperCase();
        chip.addEventListener("click", ()=>{
          [...chipsWrap.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
          chip.classList.add("active"); targetSelect.value=fmt; enableConvertIfReady();
        });
        chipsWrap.appendChild(chip);
      });

      // Preselect first available target and enable button
      if (targetSelect.options.length > 0) {
        targetSelect.selectedIndex = 0;
      }
      // If we created chips, click the first to sync UI
      const firstChip = chipsWrap.querySelector(".chip");
      if (firstChip) firstChip.click();

      enableConvertIfReady();
    }

    // keep button enabled when user changes dropdown
    targetSelect.addEventListener("change", enableConvertIfReady);

    // Drag & drop
    ["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.add("drag");}));
    ["dragleave","drop"].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.classList.remove("drag");}));
    drop.addEventListener("drop", e=>{ const f=e.dataTransfer.files?.[0]; if(f){ fileInput.files=e.dataTransfer.files; onFilePicked(f);} });

    // Both mechanisms for opening picker
    browseBtn.addEventListener("click",(e)=>{ e.preventDefault(); fileInput.click(); });
    fileInput.addEventListener("change", ()=>{ const f=fileInput.files?.[0]; if(f) onFilePicked(f); });

    function onFilePicked(file){
      resultBox.innerHTML=""; statusLine.textContent=""; bar.style.width="0%"; barInd.style.display="none"; barInd.classList.remove("indeterminate");
      const ext=extOf(file.name), cat=guessCategory(ext);
      setSuggestions(ext, cat);
      filemeta.textContent=`${file.name} — ${ext.toUpperCase()} • ${humanSize(file.size)}`;
      enableConvertIfReady();
    }

    // Local processing (unchanged; trimmed for brevity)
    const LOCAL_OK = { "pdf": new Set(["jpg","png","webp"]), "jpg": new Set(["png","webp"]), "jpeg": new Set(["png","webp"]), "png": new Set(["jpg","webp"]), "webp": new Set(["jpg","png"]), "bmp": new Set(["jpg","png","webp"]), "gif": new Set(["jpg","png","webp"]), "tiff": new Set(["jpg","png","webp"]), "ico": new Set(["png","webp"]) };
    function canDoLocal(srcExt, targetExt){ return LOCAL_OK[srcExt]?.has(targetExt) || false; }

    async function convertLocal(file, srcExt, targetExt){
      const PDF = window['pdfjsLib'];
      if(srcExt==="pdf" && ["jpg","png","webp"].includes(targetExt)){
        const buf = await file.arrayBuffer();
        const pdf = await PDF.getDocument({ data: buf }).promise;
        const pages = pdf.numPages;
        const zip = new JSZip(); let done=0;
        for(let i=1;i<=pages;i++){
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2 });
          const canvas = document.createElement("canvas"), ctx = canvas.getContext("2d");
          canvas.width=viewport.width; canvas.height=viewport.height;
          await page.render({ canvasContext: ctx, viewport }).promise;
          const mime = {jpg:"image/jpeg", png:"image/png", webp:"image/webp"}[targetExt];
          const blob = await new Promise(res=>canvas.toBlob(res, mime, mime==="image/jpeg"?0.92:0.95));
          zip.file(`page-${i}.${targetExt}`, blob);
          bar.style.width = Math.round((++done/pages)*100) + "%";
          statusLine.textContent = `Processing… ${done}/${pages}`;
        }
        const zipBlob = await zip.generateAsync({type:"blob"});
        const url = URL.createObjectURL(zipBlob);
        const name = file.name.replace(/\.pdf$/i, `_${targetExt}.zip`);
        return { url, filename: name };
      }
      if(["jpg","jpeg","png","webp","gif","tiff","bmp","ico"].includes(srcExt) &&
         ["jpg","png","webp"].includes(targetExt)){
        const bmp = await createImageBitmap(file);
        const canvas = document.createElement("canvas"), ctx=canvas.getContext("2d");
        canvas.width=bmp.width; canvas.height=bmp.height; ctx.drawImage(bmp,0,0);
        const mime = {jpg:"image/jpeg", png:"image/png", webp:"image/webp"}[targetExt];
        const blob = await new Promise(res=>canvas.toBlob(res, mime, mime==="image/jpeg"?0.92:0.95));
        const url = URL.createObjectURL(blob); const base = file.name.replace(/\.[^.]+$/,"");
        bar.style.width="100%"; statusLine.textContent="Done.";
        return { url, filename:`${base}.${targetExt}` };
      }
      throw new Error("Local conversion not supported for this format.");
    }

    // Convert click
    convertBtn.addEventListener("click", async ()=>{
      if (convertBtn.disabled) return; // guard if UI not updated yet
      const file=fileInput.files?.[0]; const target=targetSelect.value;
      if(!file || !target){ return; }

      resultBox.innerHTML=""; statusLine.textContent=""; bar.style.width="0%"; barInd.style.display="none"; barInd.classList.remove("indeterminate");

      const srcExt = extOf(file.name);
      if(localToggle.checked && canDoLocal(srcExt, target)){
        try{
          const t0=performance.now();
          const out = await convertLocal(file, srcExt, target);
          const elapsed = ((performance.now()-t0)/1000).toFixed(2);
          resultBox.innerHTML = `<span class="pill ok">Done</span> <a class="link" href="${out.url}" download="${out.filename}">Download ${out.filename}</a> <span class="muted">(⏱ ${elapsed}s)</span>`;
          return;
        }catch(e){ console.warn("Local failed, falling back", e); }
      }

      // server fallback
      statusLine.textContent="Uploading…";
      const fd=new FormData(); fd.append("file", file); fd.append("target", target);
      const xhr=new XMLHttpRequest(); xhr.open("POST","/api/convert");
      xhr.upload.onprogress=(ev)=>{ if(ev.lengthComputable){ bar.style.width=Math.round((ev.loaded/ev.total)*100)+"%"; } };
      xhr.upload.onload=()=>{ bar.style.width="100%"; statusLine.textContent="Processing…"; barInd.style.display="block"; barInd.classList.add("indeterminate"); };
      xhr.onreadystatechange=()=>{ if(xhr.readyState===XMLHttpRequest.DONE){
        barInd.classList.remove("indeterminate"); barInd.style.display="none";
        if(xhr.status===200){
          try{ const data=JSON.parse(xhr.responseText);
               const t=data.process_time?` <span class="muted">(⏱ ${data.process_time}s)</span>`:"";
               statusLine.textContent="Done.";
               resultBox.innerHTML=`<span class="pill ok">Done</span> <a class="link" href="${data.download}" download>Download ${data.filename}</a>${t}`;
          }catch{ statusLine.textContent="Done."; resultBox.textContent="Download ready."; }
        }else{
          try{ const data=JSON.parse(xhr.responseText);
               resultBox.innerHTML=`<span class="pill err">Error</span> ${data.detail||xhr.responseText}`;
          }catch{ resultBox.innerHTML=`<span class="pill err">Error</span> ${xhr.responseText||"Unknown error"}`; }
          statusLine.textContent="";
        }
      }}; xhr.send(fd);
    });

    // Cookie banner (minimal)
    const cb=document.getElementById('cookieBanner'), btnA=document.getElementById('cookieAccept'), btnD=document.getElementById('cookieDecline');
    function setCookie(n,v,d){const maxAge=d*24*60*60;document.cookie=`${n}=${encodeURIComponent(v)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;}
    function getCookie(n){return document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(n+'='))?.split('=')[1];}
    function showBannerIfNeeded(){if(!getCookie('consent')){cb.classList.add('show');}}
    btnA.addEventListener('click',()=>{setCookie('consent','accept',180);cb.classList.remove('show');});
    btnD.addEventListener('click',()=>{cb.classList.remove('show');});
    showBannerIfNeeded();
  })();
  </script>
</body>
</html>
